<?php
/**
 * Data Source class for DekkImporter
 * Handles fetching products from Klettur (BK) and Mitra (BM) APIs
 */

if (!defined('ABSPATH')) {
    exit;
}

class DekkImporter_Data_Source {
    /**
     * Plugin instance
     */
    private $plugin;

    /**
     * API endpoints
     */
    private $api_endpoints = [];

    /**
     * Constructor
     */
    public function __construct($plugin) {
        $this->plugin = $plugin;

        // Load API configuration
        $options = get_option('dekkimporter_options', []);
        $this->api_endpoints = [
            'BK' => isset($options['dekkimporter_bk_api_url']) ? $options['dekkimporter_bk_api_url'] : '',
            'BM' => isset($options['dekkimporter_bm_api_url']) ? $options['dekkimporter_bm_api_url'] : '',
        ];
    }

    /**
     * Fetch products from all data sources
     *
     * @return array Combined products from all suppliers
     */
    public function fetch_products() {
        $this->plugin->logger->log('Fetching products from all data sources');

        $all_products = [];

        // Fetch from BK supplier (Klettur)
        if (!empty($this->api_endpoints['BK'])) {
            $bk_products = $this->fetch_from_bk($this->api_endpoints['BK']);
            $all_products = array_merge($all_products, $bk_products);
        }

        // Fetch from BM supplier (Mitra) - includes 3 API calls
        if (!empty($this->api_endpoints['BM'])) {
            $bm_products = $this->fetch_from_bm($this->api_endpoints['BM']);
            $all_products = array_merge($all_products, $bm_products);
        }

        $this->plugin->logger->log('Fetched ' . count($all_products) . ' products from data sources');

        return $all_products;
    }

    /**
     * Fetch products from BK supplier (Klettur)
     */
    private function fetch_from_bk($api_url) {
        $this->plugin->logger->log("Fetching products from BK supplier: {$api_url}");

        $response = wp_remote_get($api_url, [
            'timeout' => 30,
            'headers' => ['Accept' => 'application/json'],
        ]);

        if (is_wp_error($response)) {
            $this->plugin->logger->log("API Error (BK): " . $response->get_error_message(), 'ERROR');
            return [];
        }

        $status_code = wp_remote_retrieve_response_code($response);
        if ($status_code !== 200) {
            $this->plugin->logger->log("API returned status {$status_code} for BK", 'ERROR');
            return [];
        }

        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);

        if (json_last_error() !== JSON_ERROR_NONE) {
            $this->plugin->logger->log("JSON decode error for BK: " . json_last_error_msg(), 'ERROR');
            return [];
        }

        if (!is_array($data)) {
            $this->plugin->logger->log("Invalid data format from BK", 'ERROR');
            return [];
        }

        // Process BK products
        $products = [];
        foreach ($data as $product) {
            // Filter: Only HJ-S location, QTY >= 4, RimSize >= 13, valid tire format
            if (
                isset($product['INVENTLOCATIONID']) && $product['INVENTLOCATIONID'] === 'HJ-S' &&
                isset($product['QTY']) && $product['QTY'] >= 4 &&
                isset($product['RimSize']) && $product['RimSize'] >= 13 &&
                isset($product['ItemName']) && preg_match("/^\d{2,3}[\/x]\d{2}(?:,\d{1,2})?R/", $product['ItemName']) === 1
            ) {
                $normalized = $this->normalize_bk_product($product);
                if ($normalized) {
                    $products[] = $normalized;
                }
            }
        }

        $this->plugin->logger->log("Fetched " . count($products) . " products from BK");
        return $products;
    }

    /**
     * Fetch products from BM supplier (Mitra) - includes 3 API endpoints
     */
    private function fetch_from_bm($api_url) {
        $this->plugin->logger->log("Fetching products from BM supplier: {$api_url}");

        // Mitra has 3 endpoints
        $endpoints = [
            $api_url,
            $api_url . '?g=1',
            $api_url . '?g=2',
        ];

        $all_data = [];
        foreach ($endpoints as $endpoint) {
            $response = wp_remote_get($endpoint, [
                'timeout' => 30,
                'headers' => ['Accept' => 'application/json'],
            ]);

            if (is_wp_error($response)) {
                $this->plugin->logger->log("API Error (BM - {$endpoint}): " . $response->get_error_message(), 'ERROR');
                continue;
            }

            $status_code = wp_remote_retrieve_response_code($response);
            if ($status_code !== 200) {
                $this->plugin->logger->log("API returned status {$status_code} for BM endpoint {$endpoint}", 'ERROR');
                continue;
            }

            $body = wp_remote_retrieve_body($response);
            $data = json_decode($body, true);

            if (json_last_error() !== JSON_ERROR_NONE) {
                $this->plugin->logger->log("JSON decode error for BM endpoint {$endpoint}: " . json_last_error_msg(), 'ERROR');
                continue;
            }

            if (is_array($data)) {
                $all_data = array_merge($all_data, $data);
            }
        }

        // Process BM products
        $products = [];
        foreach ($all_data as $product) {
            $normalized = $this->normalize_bm_product($product);
            if ($normalized) {
                $products[] = $normalized;
            }
        }

        $this->plugin->logger->log("Fetched " . count($products) . " products from BM");
        return $products;
    }

    /**
     * Normalize BK product data
     */
    private function normalize_bk_product($product) {
        if (empty($product['ItemId']) || empty($product['ItemName'])) {
            return null;
        }

        $sku = $product['ItemId'] . '-BK';
        $price = isset($product['Price']) ? floatval($product['Price']) * 1.24 : 0; // Apply 24% tax

        return [
            'sku' => sanitize_text_field($sku),
            'name' => sanitize_text_field($product['ItemName']),
            'price' => $price,
            'description' => '',
            'short_description' => '',
            'stock_quantity' => isset($product['QTY']) ? intval($product['QTY']) : 0,
            'image_url' => isset($product['photourl']) ? esc_url_raw($product['photourl']) : '',
            'supplier' => 'BK',
            'api_id' => sanitize_text_field($product['ItemId']),
            'last_modified' => current_time('mysql'),
            'rim_size' => isset($product['RimSize']) ? intval($product['RimSize']) : 0,
            'raw_data' => $product, // Keep original data for reference
        ];
    }

    /**
     * Normalize BM product data
     */
    private function normalize_bm_product($product) {
        if (empty($product['product_number']) || empty($product['title'])) {
            return null;
        }

        // Special handling for VN0000375
        $title = $product['title'];
        if ($product['product_number'] === 'VN0000375' && strlen($title) >= 8) {
            $title = substr($title, 0, 6) . ' ' . substr($title, 6);
        }

        $sku = $product['product_number'] . '-BM';
        $image_url = '';
        if (isset($product['card_image']) && !empty($product['card_image'])) {
            $image_url = 'https:' . $product['card_image'];
        }

        return [
            'sku' => sanitize_text_field($sku),
            'name' => sanitize_text_field($title),
            'price' => isset($product['price']) ? floatval($product['price']) : 0,
            'description' => '',
            'short_description' => '',
            'stock_quantity' => isset($product['inventory']) ? intval($product['inventory']) : 0,
            'image_url' => $image_url,
            'supplier' => 'BM',
            'api_id' => sanitize_text_field($product['product_number']),
            'last_modified' => current_time('mysql'),
            'diameter' => isset($product['diameter']) ? intval($product['diameter']) : 0,
            'raw_data' => $product, // Keep original data for reference
        ];
    }

    /**
     * Get list of active product SKUs from API
     * Used to identify obsolete products
     *
     * @return array Array of active SKUs
     */
    public function get_active_skus() {
        $products = $this->fetch_products();
        $skus = [];

        foreach ($products as $product) {
            if (!empty($product['sku'])) {
                $skus[] = $product['sku'];
            }
        }

        return $skus;
    }
}
